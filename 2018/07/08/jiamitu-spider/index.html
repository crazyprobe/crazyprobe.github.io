<!DOCTYPE html>
<html lang="zh">
<head><meta name="generator" content="Hexo 3.8.0">
    <title>zer0i3&#39;s Notes</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.1.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <script src="/js/init.js"></script>
</head></html>
<body>
    <div class="main-content" id="main-content">
        <div class="hide">
                <div class="hide-inner">
    <!--<div class="search">-->
        <!--<form action="#">-->
            <!--<input type="search" class="form-control" placeholder="Search ...">-->
        <!--</form>-->
    <!--</div>-->
    <div class="nav-menu widget">
        <ul class="navmenu-nav">
            
                <li class="menu-item">
                    <a href="/">Home</a>
                </li>
            
                <li class="menu-item">
                    <a href="/archives/">Archives</a>
                </li>
            
                <li class="menu-item">
                    <a href="/links/">Links</a>
                </li>
            
        </ul>
    </div>
    <div class="tag widget">
        <h3 class="widget-title">Tag</h3>
        <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/ctf/">ctf</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/">docker</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/">mysql</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/scrapy/">scrapy</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web/">web</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/writeup/">writeup</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/漏洞/">漏洞</a><span class="tag-list-count">1</span></li></ul>
    </div>
    <div class="categories widget">
        <h3 class="widget-title">Categories</h3>
        <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a><span class="archive-list-count">1</span></li></ul>
    </div>
</div>
        </div>
        <div class="show">
            <aside class="left-col">
                <button id="show-all" type="button" class="navbar-toggle">
    <i class="fa fa-bars"></i>
</button>
<div class="profile">
    <div class="avatar">
        <a href="/">
            <img class="img-thumbnail" src="/img/avatar.jpg" alt="">
        </a>
    </div>
    <div class="header-author">
        <a href="/">
            <h1>zer0i3</h1>
        </a>
    </div>
    <hr class="divider">
    <div class="header-subtitle">
        <p class="description">A lot can happen between now and never.</p>
    </div>
    <hr class="divider">
    <div class="social">
        <a href="Mailto:i@aiyo.xyz" class="fa fa-envelope fa-2x"></a>
        <a href="https://github.com/zer0i3" class="fa fa-github fa-2x"></a>
        <a href="/atom.xml" class="fa fa-feed fa-2x"></a>
    </div>
</div>
            </aside>
            <main class="right-col">
                <article class="post">
        <header class="post-header">
            <h1 class="post-title">
                <a href="/2018/07/08/jiamitu-spider/">加密兔爬虫(scrapy)</a>
            </h1>
            <div class="post-meta">
            <span class="author">
                作者：
                <a href="#">
                    zer0i3
                </a>
            </span>
                <time class="post-date">
                    2018-07-08
                </time>
            </div>
        </header>
        
            <div class="post-content">
                <p>之前面试要求写点小程序，记录下过程。</p>
<h3 id="一-需求"><a href="#一-需求" class="headerlink" title="一.需求"></a>一.需求</h3><p>编写一个加密兔 兔宝爬虫</p>
<p>点击链接 <a href="http://t.cn/RdGOckh" target="_blank" rel="noopener">http://t.cn/RdGOckh</a> ，登录后点击“领养”，抓取其中的兔宝数据。<br>要求：</p>
<ol>
<li><p>可以指定抓取的数量（精确到十位数即可）。</p>
</li>
<li><p>获取兔宝及父母信息。兔宝信息包括编号，代数，稀有度，当前价格。父母信息包括编号、代数、稀有度、属性（包含稀有程度）。</p>
</li>
<li><p>将兔宝与父母信息输出到文件中。</p>
</li>
<li><p>编程语言不限，使用技术不限。</p>
</li>
<li><p>抓取速度越快越好。</p>
</li>
</ol>
<h3 id="二-分析"><a href="#二-分析" class="headerlink" title="二.分析"></a>二.分析</h3><p>​    基本需求使用Scrapy框架可快速实现。</p>
<h3 id="三-环境"><a href="#三-环境" class="headerlink" title="三.环境"></a>三.环境</h3><p>​    1.Anaconda3 python3.6版本。</p>
<p>​    2.Pycharm。</p>
<a id="more"></a>
<h3 id="四-操作"><a href="#四-操作" class="headerlink" title="四.操作"></a>四.操作</h3><h4 id="1-确定兔宝列表信息请求与相应"><a href="#1-确定兔宝列表信息请求与相应" class="headerlink" title="1.确定兔宝列表信息请求与相应"></a>1.确定兔宝列表信息请求与相应</h4><p><img src="./request_response.png" alt=""></p>
<p>登陆后打开网络选项卡，滚动页面查看网络请求，发现页面通过Ajax异步请求Json格式的数据，查看请求体与返回体。原始请求url如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://jiamitu.mi.com/pet/ng/listng?page=3&amp;limit=10&amp;order=desc&amp;orderBy=update_time&amp;rare=&amp;followUp=https:%2F%2Fjiamitu.mi.com%2Fauction%3FuserId%3D19619417</span><br></pre></td></tr></table></figure>
<p>返回内容为json格式的数据： </p>
<p><img src="./response_json.png" alt=""></p>
<p>使用匿名窗口打开上述url，确定该接口需要登陆才能请求，未登录时返回结果如下，提示未授权： </p>
<p><img src="./response_401.png" alt="">删除参数进行测试，最后发现其它参数都可删除掉，只需要page及limit控制请求的数据范围即可，经测试发现limit最大可取50，如返回的Json数据所示，total值为60252，所以构造超过此值的page及limit获取当范围超出后的返回值为： </p>
<p><img src="./response_limit.png" alt=""></p>
<p>分析正常的返回值结果,单条数据json如下所示：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"generation"</span>:<span class="number">10</span>,<span class="attr">"name"</span>:<span class="string">"兔宝857243"</span>,<span class="attr">"price"</span>:<span class="number">100</span>,<span class="attr">"type"</span>:<span class="string">"兔宝"</span>,<span class="attr">"topbidder"</span>:<span class="literal">false</span>,<span class="attr">"bidded"</span>:<span class="literal">false</span>,<span class="attr">"id"</span>:<span class="number">857243</span>,<span class="attr">"rareDegree"</span>:<span class="string">"普通"</span>,<span class="attr">"pic"</span>:<span class="string">"http://t4.market.xiaomi.com/download/0c982e4a40e6545ac2e88e3b77979a133184d2e24/_.png"</span>,<span class="attr">"color"</span>:<span class="string">"#d2e6fe"</span>&#125;</span><br></pre></td></tr></table></figure>
<p>此处可以获取需求中的兔宝编号、代数、稀有度、当前价格信息。</p>
<h4 id="2-确定兔宝详细信息请求与响应"><a href="#2-确定兔宝详细信息请求与响应" class="headerlink" title="2.确定兔宝详细信息请求与响应"></a>2.确定兔宝详细信息请求与响应</h4><p>类似确定兔宝信息的方式，获取兔宝详细信息的Ajax请求url为 :</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://jiamitu.mi.com/pet/ng/getng?gid=911093&amp;followUp=https:%2F%2Fjiamitu.mi.com%2Fbabydetail%3FpetId%3D911093</span><br></pre></td></tr></table></figure>
<p>返回体内容包括了兔宝父母的json结构： </p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"petId"</span>:<span class="number">338133</span>,<span class="attr">"rareDegreeKey"</span>:<span class="string">"uncommon"</span>,<span class="attr">"rareDegree"</span>:<span class="string">"稀有"</span>,<span class="attr">"pic"</span>:&#123;<span class="attr">"backColor"</span>:<span class="string">"#fbe8e2"</span>,<span class="attr">"gene"</span>:<span class="string">""</span>,<span class="attr">"picUrl"</span>:<span class="string">"http://t1.market.xiaomi.com/download/DaCenter/0905b45338cd543c620c6c34672a9e89817f2a935/dd442ee7g63g111135d36fg227e2111ewwwwwwwwwwwwwwww.png"</span>&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-确定父母详细信息请求与响应"><a href="#3-确定父母详细信息请求与响应" class="headerlink" title="3.确定父母详细信息请求与响应"></a>3.确定父母详细信息请求与响应</h4><p>分析网络请求，获取父母详细信息的Ajax请求url为：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://jiamitu.mi.com/pet/detail?petId=338133&amp;followUp=https:%2F%2Fjiamitu.mi.com%2Fmitudetail%3FpetId%3D338133</span><br></pre></td></tr></table></figure>
<p>返回体内容包括了父母的详细信息及其父母，如下所示：</p>
<p><img src="./response_detail.png" alt="">此处可根据需求决定是否递归获取其父母详细信息。</p>
<h4 id="4-确定登陆请求"><a href="#4-确定登陆请求" class="headerlink" title="4.确定登陆请求"></a>4.确定登陆请求</h4><p>​    爬取操作需要登陆后才能进行，所以首先需要进行用户登陆操作，此处登陆页面使用Js动态创建，无法单纯使用scrapy模拟登陆，后续考虑结合使用无界面浏览器实现账户登陆操作。此处暂时先使用cookie设置登陆状态 。</p>
<h3 id="五-问题"><a href="#五-问题" class="headerlink" title="五.问题"></a>五.问题</h3><h4 id="1-响应为403"><a href="#1-响应为403" class="headerlink" title="1.响应为403"></a>1.响应为403</h4><p>开始爬取后，部分页面返回结果正常，部分为403页面：</p>
<p><img src="./code_403.png" alt=""></p>
<p>经手动测试发现当快速进行页面刷新操作时，将返回403响应如下： </p>
<p><img src="./response_403.png" alt="">但当page值较小时基本不出现该问题，当page值较大时很容易出现该问题，因该问题间歇性出现，所以采用规避方式，对返回值为403的url均重新进行请求，直至返回正确结果 。</p>
<h4 id="2-爬取效果"><a href="#2-爬取效果" class="headerlink" title="2.爬取效果"></a>2.爬取效果</h4><p><img src="./result.png" alt=""></p>
<p>使用scrapy默认配置，并发请求最大为16，爬取兔宝信息，并递归爬取其父母信息，爬取结束共花费100分钟左右，其中因为某些页面存在403错误，所以重复请求277722次，最终获取兔宝信息6w+,父母信息22w+</p>
<h4 id="3-后续优化"><a href="#3-后续优化" class="headerlink" title="3.后续优化"></a>3.后续优化</h4><ul>
<li>可以使用无界面浏览器获取登陆表单，实现账号密码登陆</li>
<li>可以结合Web框架实现可视化操作与结果展示</li>
<li>可以使用Redis管理任务队列，结合多进程、或Docker加分布式来实现更快速度的爬取</li>
<li>目前没有观察到反爬措施，如果后续发生，可结合使用代理池与Cookie池</li>
</ul>
<h4 id="4-代码运行"><a href="#4-代码运行" class="headerlink" title="4.代码运行"></a>4.代码运行</h4><p>安装Anaconda3后，使用conda install scrapy安装运行环境，运行spider目录下的start.py即可，爬取数目与登陆cookie可在settings.py中设置</p>
<h4 id="5-项目地址"><a href="#5-项目地址" class="headerlink" title="5.项目地址"></a>5.项目地址</h4><p><a href="https://github.com/zer0i3/jiamitu_scrapy.git" target="_blank" rel="noopener">https://github.com/zer0i3/jiamitu_scrapy.git</a></p>

            </div>
          
        
            <footer class="post-footer">
                <class class="pull-left tag-list">
                    <i class="fa fa-folder-open-o"></i>
                    
                        <a href="/tags/scrapy/">scrapy</a>
                      
                </class>
            </footer>
        
</article>
                <footer class="footer-info">
    <div class="footer-left">
        <i class="fa fa-copyright"></i>2019 zer0i3
    </div>
    <div class="footer-right">
        <a href="https://hexo.io">Hexo</a>
        <span>Theme</span>
        <a href="https://github.com/zer0i3/hexo-theme-zob">zob</a>
        <span>by <i class="fa fa-heart"></i>zer0i3</span>
    </div>
</footer>
            </main>
        </div>
    </div>
</body>
</html>