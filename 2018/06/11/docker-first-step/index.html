<!DOCTYPE html>
<html lang="zh">
<head><meta name="generator" content="Hexo 3.8.0">
    <title>zer0i3&#39;s Notes</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.1.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <script src="/js/init.js"></script>
</head></html>
<body>
    <div class="main-content" id="main-content">
        <div class="hide">
                <div class="hide-inner">
    <!--<div class="search">-->
        <!--<form action="#">-->
            <!--<input type="search" class="form-control" placeholder="Search ...">-->
        <!--</form>-->
    <!--</div>-->
    <div class="nav-menu widget">
        <ul class="navmenu-nav">
            
                <li class="menu-item">
                    <a href="/">Home</a>
                </li>
            
                <li class="menu-item">
                    <a href="/archives/">Archives</a>
                </li>
            
                <li class="menu-item">
                    <a href="/links/">Links</a>
                </li>
            
        </ul>
    </div>
    <div class="tag widget">
        <h3 class="widget-title">Tag</h3>
        <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/ctf/">ctf</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/">docker</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/">mysql</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/scrapy/">scrapy</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web/">web</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/writeup/">writeup</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/漏洞/">漏洞</a><span class="tag-list-count">1</span></li></ul>
    </div>
    <div class="categories widget">
        <h3 class="widget-title">Categories</h3>
        <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a><span class="archive-list-count">1</span></li></ul>
    </div>
</div>
        </div>
        <div class="show">
            <aside class="left-col">
                <button id="show-all" type="button" class="navbar-toggle">
    <i class="fa fa-bars"></i>
</button>
<div class="profile">
    <div class="avatar">
        <a href="/">
            <img class="img-thumbnail" src="/img/avatar.jpg" alt="">
        </a>
    </div>
    <div class="header-author">
        <a href="/">
            <h1>zer0i3</h1>
        </a>
    </div>
    <hr class="divider">
    <div class="header-subtitle">
        <p class="description">A lot can happen between now and never.</p>
    </div>
    <hr class="divider">
    <div class="social">
        <a href="Mailto:i@aiyo.xyz" class="fa fa-envelope fa-2x"></a>
        <a href="https://github.com/zer0i3" class="fa fa-github fa-2x"></a>
        <a href="/atom.xml" class="fa fa-feed fa-2x"></a>
    </div>
</div>
            </aside>
            <main class="right-col">
                <article class="post">
        <header class="post-header">
            <h1 class="post-title">
                <a href="/2018/06/11/docker-first-step/">Docker初步使用</a>
            </h1>
            <div class="post-meta">
            <span class="author">
                作者：
                <a href="#">
                    zer0i3
                </a>
            </span>
                <time class="post-date">
                    2018-06-11
                </time>
            </div>
        </header>
        
            <div class="post-content">
                <p>​    之前一直听说Docker是个好东西，但是一直没仔细去了解一下，现在有了搭建环境的需求，发现使用Docker是真的方便。具体的教程这里有很详细的 <a href="https://yeasy.gitbooks.io/docker_practice/" target="_blank" rel="noopener">Docker从入门到实践</a>，就不细说了。这里说一点自己的理解。</p>
<h3 id="虚拟机-VS-Docker"><a href="#虚拟机-VS-Docker" class="headerlink" title="虚拟机 VS Docker"></a>虚拟机 VS Docker</h3><p>​    Docker主要是解决软件的环境配置问题，与虚拟机相比，它更加轻量。虚拟机就是一台虚拟的电脑，而Docker只是对进程做了隔离，它直接使用系统的内核。这里可以说一下的是因为Docker从Linux发展而来，很多镜像都以Linux为基础，而Docker其实会使用系统的内核。所以Docker是肯定不能直接使用Windows内核的，安装Windows版本的Docker需要启用Hyper-v或者使用VirtualBox先安装一个Linux虚拟机然后使用它的内核。但因为这其中有很多优化，所以Windows使用Docker效率仍然会比用虚拟机强很多。<br><a id="more"></a></p>
<h3 id="Docker组成"><a href="#Docker组成" class="headerlink" title="Docker组成"></a>Docker组成</h3><p>​    主要包括了镜像、容器、仓库，简单使用的话其实主要是对镜像和容器的操作，而仓库可以用来搜索、下载镜像。</p>
<p>​    这里记一下几个最常用的指令</p>
<blockquote>
<p>docker container run -p 80:80 -dit –rm   image  # 运行指定的镜像，如果不存在则从官方库中下载</p>
<p> -p进行容器内外端口映射      -d 指定后台运行     -i 进行交互</p>
<p> -t 通过终端进行交互  –rm 运行结束后自动删除生成的镜像</p>
</blockquote>
<p>​    进入容器的终端非常常用</p>
<blockquote>
<p>docker exec -it  containerid  bash    # 执行容器的bash指令，使用户进入shell</p>
</blockquote>
<p>更新分界线 2018.10.14</p>
<hr>
<h3 id="解决mysql无法启动问题"><a href="#解决mysql无法启动问题" class="headerlink" title="解决mysql无法启动问题"></a>解决mysql无法启动问题</h3><p>以下部分参考自<a href="https://github.com/moby/moby/issues/34390" target="_blank" rel="noopener">moby issues</a> </p>
<p>有时候会有将多服务部署在同一容器中的需求，但是自己安装的mysql有时候会有启动失败的情况，具体来说就是一直显示starting….然后静默失败,或者像下面</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker build -t mysql-fails .</span><br><span class="line">docker <span class="keyword">run</span> -it mysql-fails /bin/bash -c 'service mysql start'</span><br><span class="line">[FAIL] Starting MySQL database server: mysqld . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . failed!</span><br></pre></td></tr></table></figure>
<p>总结一下，这个问题其实是因为写入权限的原因，mysql 启动的时候需要拥有 <code>/var/lib/mysql</code>目录的写权限，而docker构建的时候是分层构建的，所以当mysql启动的时候如果这个目录不可写就会出现这个问题。查看官方mysql的启动脚本其实也有类似处理：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">RUN &#123; \</span><br><span class="line">		echo mysql-community-server mysql-community-server/data-dir select ''; \</span><br><span class="line">		echo mysql-community-server mysql-community-server/root-pass password ''; \</span><br><span class="line">		echo mysql-community-server mysql-community-server/re-root-pass password ''; \</span><br><span class="line">		echo mysql-community-server mysql-community-server/remove-test-db select false; \</span><br><span class="line">	&#125; | debconf-set-selections \</span><br><span class="line">	&amp;&amp; apt-get update &amp;&amp; apt-get install -y mysql-server="$&#123;MYSQL_VERSION&#125;" &amp;&amp; rm -rf /var/lib/apt/lists/* \</span><br><span class="line">	&amp;&amp; rm -rf /var/lib/mysql &amp;&amp; mkdir -p /var/lib/mysql /var/run/mysqld \</span><br><span class="line">	&amp;&amp; chown -R mysql:mysql /var/lib/mysql /var/run/mysqld \</span><br><span class="line"><span class="meta">#</span> ensure that /var/run/mysqld (used for socket and lock files) is writable regardless of the UID our mysqld instance ends up having at runtime</span><br><span class="line">	&amp;&amp; chmod 777 /var/run/mysqld</span><br></pre></td></tr></table></figure>
<p>上述命令中先删除/var/lib/mysql，又进行创建，以此保证目录可写，所以解决这个问题有两种方式：</p>
<ul>
<li>启动mysql前先执行<code>find /var/lib/mysql/mysql -exec touch -c -a {} +</code> ，这是上面的issues中提到的，属于dirty hack的方式，具体来说这条命令其实什么也没干，只是修改了mysql这个目录下的文件时间，但是执行该命令后目录变得可写了</li>
<li><strong>推荐</strong> 使用匿名卷，<code>VOLUME /var/lib/mysql</code>在dockerfile中使用这样的语法,如果使用的时候不进行卷映射，将会自动映射匿名卷，这样更符合使用docker的推荐方式，即不将数据存储在存储层而是存储在卷中。</li>
</ul>

            </div>
          
        
            <footer class="post-footer">
                <class class="pull-left tag-list">
                    <i class="fa fa-folder-open-o"></i>
                    
                        <a href="/tags/docker/">docker</a>
                      
                        <a href="/tags/mysql/">mysql</a>
                      
                </class>
            </footer>
        
</article>
                <footer class="footer-info">
    <div class="footer-left">
        <i class="fa fa-copyright"></i>2019 zer0i3
    </div>
    <div class="footer-right">
        <a href="https://hexo.io">Hexo</a>
        <span>Theme</span>
        <a href="https://github.com/zer0i3/hexo-theme-zob">zob</a>
        <span>by <i class="fa fa-heart"></i>zer0i3</span>
    </div>
</footer>
            </main>
        </div>
    </div>
</body>
</html>